# Public domain notice for all NCBI EDirect scripts is located at:
# https://www.ncbi.nlm.nih.gov/books/NBK179288/#chapter6.Public_Domain_Notice

# datafiles-nihocc

if [ -d "${extrasBase}" ]
then
  cd "${extrasBase}"

  base_url=""
  new_file_date=""

  latest_occ=$(
    nquire -bulk -get https://api.figshare.com/v2/collections/4586573/articles |
    xtract -pattern anon -sort-rev published_date |
    xtract -pattern anon -position first -element "*"
  )
  if [ -n "$latest_occ" ]
  then
    base_url=$( echo "$latest_occ" | xtract -pattern anon -element url )
    new_file_date=$( echo "$latest_occ" | xtract -pattern anon -element published_date | cut -c 1-10 )
  fi

  if [ -f "open_citation_collection.zip" ] && [ -n "$new_file_date" ]
  then
    curr_file_date=$( date -r open_citation_collection.zip "+%Y-%m-%d" )
    if [ -n "$curr_file_date" ]
    then
      if [[ "$new_file_date" > "$curr_file_date" ]]
      then
        echo "Removing old $curr_file_date download of open_citation_collection.zip" >&2
        rm -f "open_citation_collection.zip"
      else
        echo "Current public $new_file_date version of open_citation_collection.zip is not later than existing $curr_file_date download" >&2
      fi
    fi
  fi

  if [ ! -f "open_citation_collection.zip" ] && [ -n "$base_url" ]
  then
    download_url=$(
      nquire -get "$base_url" |
      xtract -pattern opt -group files \
        -if name -equals open_citation_collection.zip \
          -element download_url
    )
    if [ -n "$download_url" ]
    then
      orig_name=$( echo "${download_url}" | tr '/' '\n' | tail -n 1 )
      echo "Downloading new $new_file_date version of open_citation_collection.zip will likely take at least two to three hours" >&2
      nquire -get "$download_url" > open_citation_collection.zip
      if [ -f "open_citation_collection.zip" ]
      then
        echo "Downloading open_citation_collection.zip is complete" >&2
      else
        echo "Downloading of open_citation_collection.zip failed" >&2
      fi
    fi
  fi

  if [ ! -f "open_citation_collection.zip" ]
  then
    echo "ERROR: Unable to download open_citation_collection.zip file to Extras directory" >&2
    echo "" >&2
    echo "EXITING DUE TO MISSING NCBI OCC DATA FILE" >&2
    exit 1
  fi
fi
